---
import DashboardLayout from '../../components/dashboard/DashboardLayout.astro'
import { supabase } from '../../utils/database'
import type { Client, DecisionQuery, PDPAudit } from '../../../supabase/types'

let client: Client | null = null
let queries: DecisionQuery[] = []
let audits: PDPAudit[] = []

if (supabase) {
  const { data: clients } = await supabase.from('clients').select('*').eq('active', true).limit(1)
  client = clients?.[0] || null
  if (client) {
    const { data: q } = await supabase.from('decision_queries').select('*').eq('client_id', client.id).eq('status', 'active')
    queries = q || []
    const { data: a } = await supabase.from('pdp_audits').select('*').eq('client_id', client.id).order('audited_at', { ascending: false }).limit(10)
    audits = a || []
  }
}

// Use mock data if no real data
if (!client) {
  client = { id: 'demo', name: 'Demo Brand', domain: 'demobrand.com', active: true } as Client
}
if (queries.length === 0) {
  queries = [
    { id: '1', query: 'best gravel wheels for heavy riders', priority: 'high', cluster: 'Product Research' },
    { id: '2', query: 'carbon vs alloy wheelset comparison', priority: 'critical', cluster: 'Comparison' },
    { id: '3', query: 'tubeless gravel wheels review 2024', priority: 'medium', cluster: 'Reviews' },
  ] as DecisionQuery[]
}
if (audits.length === 0) {
  audits = [
    { id: '1', product_title: 'Carbon Gravel Wheelset Pro', url: 'https://demo.com/wheels/carbon-pro', overall_score: 85 },
    { id: '2', product_title: 'Alloy Adventure Wheels', url: 'https://demo.com/wheels/alloy-adventure', overall_score: 72 },
    { id: '3', product_title: 'Tubeless Ready Set', url: 'https://demo.com/wheels/tubeless-ready', overall_score: 58 },
  ] as PDPAudit[]
}

const avgScore = audits.length ? Math.round(audits.reduce((s, a) => s + (a.overall_score || 0), 0) / audits.length) : 0
---

<DashboardLayout title="Overview" client={client} currentPath="/dashboard">
  <div class="kpis">
    <div class="kpi"><span class="kpi-v">{queries.length}</span><span class="kpi-l">Queries</span></div>
    <div class="kpi"><span class="kpi-v">{audits.length}</span><span class="kpi-l">Audits</span></div>
    <div class="kpi"><span class="kpi-v">{avgScore}%</span><span class="kpi-l">Avg Score</span></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-h">
        <span>Recent Audits</span>
        <a href="/dashboard/pdp-audits" class="link">View all →</a>
      </div>
      <table>
        <thead><tr><th>Product</th><th>Score</th></tr></thead>
        <tbody>
          {audits.slice(0, 5).map(a => (
            <tr>
              <td><span class="trunc">{a.product_title || a.url}</span></td>
              <td><span class:list={['score', (a.overall_score || 0) >= 80 ? 'score-g' : (a.overall_score || 0) >= 60 ? 'score-y' : 'score-r']}>{a.overall_score}</span></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-h">
        <span>Active Queries</span>
        <a href="/dashboard/queries" class="link">View all →</a>
      </div>
      <table>
        <thead><tr><th>Query</th><th>Priority</th></tr></thead>
        <tbody>
          {queries.slice(0, 5).map(q => (
            <tr>
              <td><span class="trunc">{q.query}</span></td>
              <td><span class:list={['badge', q.priority === 'critical' ? 'badge-r' : q.priority === 'high' ? 'badge-y' : 'badge-n']}>{q.priority}</span></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</DashboardLayout>

<style>
  .kpis { display: flex; gap: 12px; margin-bottom: 20px; }
  .kpi { background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 14px 18px; }
  .kpi-v { font-size: 22px; font-weight: 700; display: block; color: #111; }
  .kpi-l { font-size: 11px; color: #6b7280; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
  .card-h { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; font-size: 12px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: #111; }
  .link { font-size: 11px; color: #ea580c; text-decoration: none; }
  .link:hover { text-decoration: underline; }

  table { width: 100%; border-collapse: collapse; }
  th { padding: 8px 12px; text-align: left; font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; background: #f9fafb; }
  td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; font-size: 13px; color: #111; }
  tr:last-child td { border-bottom: none; }

  .trunc { display: block; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .score { min-width: 28px; height: 22px; padding: 0 6px; font-size: 11px; font-weight: 700; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; }
  .score-g { background: #ecfdf5; color: #059669; }
  .score-y { background: #fffbeb; color: #d97706; }
  .score-r { background: #fef2f2; color: #dc2626; }

  .badge { display: inline-block; padding: 2px 6px; font-size: 10px; font-weight: 600; border-radius: 3px; text-transform: uppercase; }
  .badge-g { background: #ecfdf5; color: #059669; }
  .badge-y { background: #fffbeb; color: #d97706; }
  .badge-r { background: #fef2f2; color: #dc2626; }
  .badge-n { background: #f3f4f6; color: #6b7280; }

  @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
</style>
